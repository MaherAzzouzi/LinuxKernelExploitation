#include <inttypes.h>
#include <sys/types.h>
#include <stdio.h>
#include <linux/userfaultfd.h>
#include <pthread.h>
#include <errno.h>
#include <unistd.h>
#include <stdlib.h>
#include <fcntl.h>
#include <signal.h>
#include <poll.h>
#include <string.h>
#include <sys/mman.h>
#include <sys/syscall.h>
#include <sys/ioctl.h>
#include <poll.h>

void errExit(char* message){
	puts(message);
	exit(-1);
}

static void * fault_handler_thread(void *arg){
	static struct uffd_msg msg;
	long uffd;

	uffd = (long)arg;
	
	for(;;){
		struct pollfd pollfd = {
			.fd = uffd,
			.events = POLLIN
		};

		poll(&pollfd, 1, -1);
		read(uffd, &msg, sizeof msg);

		if(msg.event & UFFD_EVENT_PAGEFAULT){
			printf("An event happened!\n");
			exit(0);
		}
	
	}

}

int main(){

	long uffd;
	char* mmaped_ptr;
	unsigned int len;
	pthread_t thread;
	struct uffdio_api uffdio_api;
	struct uffdio_register uffdio_register;
	
	len = 4096*4;
	mmaped_ptr = mmap(NULL, len, PROT_READ|PROT_WRITE,
			MAP_PRIVATE|MAP_ANONYMOUS, -1, 0);
	
	printf("MMAPED CHUNK : %p\n", mmaped_ptr);

	uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);
	if(uffd == -1)
		errExit("userfaultfd initialization fault!\n");

	// uffdio api
	uffdio_api.api = UFFD_API;
	uffdio_api.features = 0;
	
	if(ioctl(uffd, UFFDIO_API, &uffdio_api) == -1)
		errExit("ioctl : UFFDIO_API\n");

	//uffdio register
	uffdio_register.range.start = (unsigned long)mmaped_ptr;
	uffdio_register.range.len = len;
	uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;
	if(ioctl(uffd, UFFDIO_REGISTER, &uffdio_register) == -1)
		errExit("ioctl : UFFDIO_REGISTER\n");

	int p;
	p = pthread_create(&thread, NULL, fault_handler_thread, (void *)uffd);

	if(p!=0)
		errExit("Error creating the fault handler thread.\n");


//	*(char *)mmaped_ptr = 'M';	
	char c = *(char *)mmaped_ptr;
	return 0;
}
